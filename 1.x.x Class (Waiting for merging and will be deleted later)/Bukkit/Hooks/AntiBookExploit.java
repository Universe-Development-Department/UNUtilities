package id.universenetwork.utilities.bukkit.Hooks;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.ProtocolManager;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import id.universenetwork.utilities.bukkit.Filters.BookFilter;
import id.universenetwork.utilities.bukkit.Filters.FilterAction;
import id.universenetwork.utilities.bukkit.Handlers.BookExploitHandler;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;

import static com.comphenix.protocol.events.ListenerPriority.LOW;
import static id.universenetwork.utilities.bukkit.manager.Config.ABEEnabled;
import static id.universenetwork.utilities.bukkit.UNUtilities.plugin;
import static java.util.logging.Level.WARNING;
import static org.bukkit.Bukkit.getLogger;

public class AntiBookExploit {
    public static void activate(final BookFilter bookFilter, final BookExploitHandler config) {
        ProtocolManager manager = ProtocolLibrary.getProtocolManager();
        manager.addPacketListener(new PacketAdapter(plugin, LOW, PacketType.Play.Client.SET_CREATIVE_SLOT) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if (ABEEnabled()) {
                    final Player player = event.getPlayer();
                    ItemStack item = event.getPacket().getItemModifier().readSafely(0);
                    ItemStack filteredItem = bookFilter.filterBook(item, player, FilterAction.CREATE);
                    if (filteredItem != null) {
                        event.setCancelled(true);
                        event.getPlayer().updateInventory();
                        getLogger().log(WARNING, "Player {0} {1} tried to create a book with illegal click events!", new Object[]{player.getName(), player.getUniqueId()});
                        if (config.getPlayerMessage() != null) player.sendMessage(config.getPlayerMessage());
                    }
                }
            }
        });
    }
}